#! /bin/bash

REPO="$HOME/deap-setup"

main() {
	case "$1" in
		"install")
			check_network
			install
			exit
			;;
		"update")
			check_network
			update
			exit
			;;
		*)
			echo "Usage: '$0 install'"
			echo "       '$0 update'"
			;;
	esac
}

install() {
	install_scripts
	install_local_data
	install_packages
}

update() {
	install_scripts
	install_local_data
}

install_packages() {
	# update the list of available software
	sudo apt-get update

	# apply any software updates
	sudo apt-get upgrade -y

	# apply any system updates
	sudo apt-get dist-upgrade -y

	# install the graphic interfaces
	sudo apt-get install -y xserver-xorg xinit raspberrypi-ui-mods gvfs
	# remove screensaver
	sudo apt-get remove -y xscreensaver
	sudo apt-get autoremove -y

	# install applications
	sudo apt-get install -y lxterminal qjackctl sooperlooper zynaddsubfx

	# install pure data
	# download package
	PD_VERSION="2.2.3"
	# TODO: make this support more architectures and distros
	case (uname -p) in
		"x86_64")
			PD_SYS=ubuntu_16.04
			PD_ARCH=amd64
			;;
		*)
			PD_SYS=raspbian
			PD_ARCH=armv7l
			;;
	esac
	wget 'https://github.com/agraef/purr-data/releases/download/'"$PD_VERSION"'/pd-l2ork-'"$PD_VERSION"'-'"$PD_SYS"'-'"$PD_ARCH" -O /tmp/pd-l2ork.deb
	# install package
	sudo dpkg -i /tmp/pd-l2ork.deb
	# fix unmet dependencies
	sudo apt-get -f -y install
	# install other dependencies
	sudo apt-get install -y libnss3 libgconf2-4

	# clean up after ourselves
	sudo apt-get clean
}

install_scripts() {
	update_repo
	SCRIPT_FOLDER="/home/pi/bin"
	mkdir -p "$SCRIPT_FOLDER"
	SCRIPTS="$REPO"/bin/*
	for f in $SCRIPTS
	do
		cp -f $f $SCRIPT_FOLDER/
		chmod +x $f
	done

	# add ~/bin to path
	update_path $SCRIPT_FOLDER
}

install_local_data() {
	update_repo
	cp -r "$REPO"/local "$HOME"/.local
}

update_repo() {
	# check if git is installed
	if hash git 2>/dev/null; then
		:
	else
		sudo apt-get update
		sudo apt-get install -y git
	fi

	# check if directory already exists
	if [ -d $REPO/.git ]; then
		echo "Pulling Repo"
		git --git-dir="$REPO" pull
	else
		echo "Cloning Repo"
		git clone "https://github.com/braydenm303/deap-setup" "$REPO"
	fi
}

check_network() {
	test=github.com
	if nc -zw1 $test 443 && echo |openssl s_client -connect $test:443 2>&1 |awk '
		handshake && $1 == "Verification" { if ($2=="OK") exit; exit 1 }
		$1 $2 == "SSLhandshake" { handshake = 1 }'
	then
		:
	else
		echo "No internet connection."
		echo "Scanning for available networks..."
		sudo iwlist wlan0 scan | grep SSID
		read -p "Wifi name (SSID): " wifi_name
		read -p "Wifi password (PSK): " wifi_password
		wpa_passphrase "$wifi_name" "$wifi_password" | sudo tee -a /etc/wpa_supplicant/wpa_supplicant.conf > /dev/null
		sudo wpa_cli reconfigure
	fi

}

# update_path taken from https://unix.stackexchange.com/questions/124444/how-can-i-cleanly-add-to-path
update_path() { case ":${PATH:=$1}:" in *:$1:*) ;; *) PATH="$1:$PATH" ;; esac; }


# run the main function
main "$@"
