#! /bin/bash

REPO="$HOME/deap-setup"

main() {
	case "$1" in
		"install")
			install
			exit
			;;
		"update")
			update
			exit
			;;
		*)
			echo "Usage: '$0 install'"
			echo "       '$0 update'"
			;;
	esac
}

install() {
	install_scripts
	install_local_data
	install_packages
}

update() {
	install_scripts
	install_local_data
}

install_packages() {
	check_network

	# update the list of available software
	sudo apt-get update

	# apply any software updates
	sudo apt-get upgrade -y

	# apply any system updates
	sudo apt-get dist-upgrade -y

	# install the graphic interfaces
	case $(uname -p) in
		"x86_64")
			# leave this to the user to decide, for example:
			# sudo apt-get install lubuntu-desktop
			;;
		*) # fallback to raspbian
			sudo apt-get install -y xserver-xorg xinit raspberrypi-ui-mods gvfs
			# install terminal
			sudo apt-get install -y lxterminal

			# install a browser
			sudo apt-get install -y midori
			# sudo apt-get install -y chromium
			;;
	esac

	# remove screensaver
	sudo apt-get remove -y xscreensaver
	sudo apt-get autoremove -y

	# install audio applications
	sudo apt-get install -y \
		amsynth \
		audacity \
		calf-plugins \
		drumkv1 \
		petri-foo \
		qjackctl \
		samplv1 \
		sooperlooper \
		synthv1 \
		zynaddsubfx

	#TODO: install JSampler TouchOSC Sunvox Carla Kxstudio 

	# install pure data
	# download package
	PD_version="2.2.3"
	# TODO: make this support more architectures and distros
	case $(uname -p) in
		"x86_64")
			PD_sys=ubuntu_16.04
			PD_arch=amd64
			;;
		*) # fallback to raspbian
			PD_sys=raspbian
			PD_arch=armv7l
			;;
	esac
	# check if pd is installed
	Current_PD_version="$(pd-l2ork -version)"
	if [[ $Current_PD_version != *$PD_version* ]]
	then
		wget 'https://github.com/agraef/purr-data/releases/download/'"$PD_version"'/pd-l2ork-'"$PD_version"'-'"$PD_sys"'-'"$PD_arch"'.deb' -O /tmp/pd-l2ork.deb
		# install package
		sudo dpkg -i /tmp/pd-l2ork.deb
	else
		# pd already installed and up to date
		echo "pd-l2ork already installed"
	fi
	# fix unmet dependencies
	sudo apt-get -f -y install
	# install other dependencies
	sudo apt-get install -y libnss3 libgconf2-4

	# clean up after ourselves
	sudo apt-get clean
}

install_scripts() {
	update_repo
	SCRIPT_FOLDER="$HOME/bin"
	mkdir -p "$SCRIPT_FOLDER"
	SCRIPTS="$REPO"/bin/*
	for f in $SCRIPTS
	do
		cp -f $f $SCRIPT_FOLDER/
		chmod +x $f
	done

	# add ~/bin to path
	update_path $SCRIPT_FOLDER
}

install_local_data() {
	update_repo
	cp -r "$REPO"/local/* "$HOME"/.local

	# restart menu to get new entries
	lxpanelctl restart
}

update_repo() {
	check_network

	# check if git is installed
	if hash git 2>/dev/null; then
		:
	else
		sudo apt-get update
		sudo apt-get install -y git
	fi

	# check if directory already exists
	if [ -d $REPO/.git ]; then
		git -C "$REPO" pull > /dev/null
	else
		git clone "https://github.com/braydenm303/deap-setup" "$REPO"
	fi
}

check_network() {
	test=github.com
	if nc -zw1 $test 443 && echo |openssl s_client -connect $test:443 2>&1 |awk '
		handshake && $1 == "Verification" { if ($2=="OK") exit; exit 1 }
		$1 $2 == "SSLhandshake" { handshake = 1 }'
	then
		:
	else
		echo "No internet connection."
		echo "Scanning for available networks..."
		sudo iwlist wlan0 scan | grep SSID
		read -p "Wifi name (SSID): " wifi_name
		read -p "Wifi password (PSK): " wifi_password
		wpa_passphrase "$wifi_name" "$wifi_password" | sudo tee -a /etc/wpa_supplicant/wpa_supplicant.conf > /dev/null
		sudo wpa_cli reconfigure
	fi

}

# update_path taken from https://unix.stackexchange.com/questions/124444/how-can-i-cleanly-add-to-path
update_path() { case ":${PATH:=$1}:" in *:$1:*) ;; *) PATH="$1:$PATH" ;; esac; }


# run the main function
main "$@"
